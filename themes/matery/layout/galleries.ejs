<link rel="stylesheet" href="<%- theme.jsDelivr.url %><%- url_for(theme.libs.css.gallery) %>">

<!-- <%- partial('_partial/bg-cover') %> -->

<!-- 该主题自带的lightGallery.js在图片多的时候会很卡，所以弃用，使用了一个我在网上找的baguetteBox，很轻量级，就是功能少了点 -->
<style>
    .my-gallery .photo img {
        transition: all 0.6s ease-in-out;
    }
    .my-gallery .photo:hover img {
        opacity: 0.6;
        transform: scale(1.05);
    }
    .my-gallery {
        margin: 20px auto;
    }
    .miaoshus .title {
        font-family: MV Boli;
    }
    .miaoshus {
        padding: 20px;
        border: 1px dashed #e6e6e6;
        color: #969696;
        position: relative;
        display: inline-block;
        width: 75%;
        background: #fbfbfb50;
        border-radius: 10px;
        font-size: 16px;
        margin: 24px auto 12px;

    }
    body.dark .miaoshus {
        background: 0 0;
        border: 1px dashed #888;
    }
    body {
        overflow: visible!important;
    }
    .box {
        position: relative;
    }
    .box img {
        width: 350px;
        vertical-align: top;
        padding: 8px;
        border-radius: 10px;
        transition: all 0.5s;
    }
    .box img:hover {
        transform: scale(1.05);
    }
    .page-footer {
        display: none
    }
    body {
        overflow-y: visible!important;
    }
    header {
        background-color: #000;
    }
    .biaotiss {
        font-family: MV Boli;
    }
    @media only screen and (max-width: 1058px) {
        .box {
            margin-left: 145px;
        }
    }
    @media only screen and (max-width: 770px) {
        .box {
            margin-left: 15px;
        }
    }
    @media only screen and (max-width: 500px) {
        #previous-button, #next-button {
            display: none;
        }
    }
    @media only screen and (max-width: 380px) {
        .box {
            margin-left: -5px;
        }
    }
    @media only screen and (max-width: 323px) {
        .box img {
            width: 296px;
            left: 0;
        }
    }
</style>

<div class="tag-title center-align">
    <div class="miaoshus">
        <div class="title center-align">
            “ <% if (is_home() && config.subtitle && config.subtitle.length > 0) { %>
                <%= config.subtitle %>
            <% } else { %>
                <%= page.title %>
            <% } %> ”
        </div>
    </div>
</div>

<main class="content">
    <div class="container">
        <% if (site.data && site.data.gallery) { %>
            <% var galleries = site.data.gallery;
                var pageTitle = page.title;
                function getCurrentGallery(galleries, pageTitle) {
                    for (let i = 0; i < galleries.length; i++) {
                        if (galleries[i]['name'] == pageTitle) {
                            return galleries[i];
                        }
                    }
                }
                var currentGallery = getCurrentGallery(galleries, pageTitle);
                var photos = currentGallery.album;
            %>
            <div class="gallery-wrapper row">
                <% for (var i = 0, len = photos.length; i < len; i++) { %>
                    <% var my_album = photos[i]; %>
                    <div class="col s6 m4 l4 xl3 gallery-box">
                        <a href="javascript:void(0)" class="gallery-item" data-aos="zoom-in-up" onclick="openImagePreview(<%- i %>, '<%- my_album.img_url %>')">
                            <div class="gallery-cover-box" style="background-image: url(<%- my_album.img_url %>)">
                            </div>
                            <p class="gallery-name">
                                <%- my_album.title %>
                            </p>
                        </a>
                    </div>
                <% } %>
            </div>
        <% } %>
    </div>
    
    <!-- 图片预览模态框 -->
    <div id="imagePreviewModal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); cursor: pointer;" onclick="closeImagePreview()">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; height: 90%; display: flex; align-items: center; justify-content: center;">
            <img id="previewImage" src="" style="max-width: 100%; max-height: 100%; width: auto; height: auto; object-fit: contain;" onclick="event.stopPropagation();" />
        </div>
        
        <!-- 左右导航按钮 -->
        <div id="prevBtn" style="position: absolute; left: 20px; top: 50%; transform: translateY(-50%); color: white; font-size: 40px; cursor: pointer; user-select: none; padding: 10px;" onclick="event.stopPropagation(); prevImage();">&lt;</div>
        <div id="nextBtn" style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); color: white; font-size: 40px; cursor: pointer; user-select: none; padding: 10px;" onclick="event.stopPropagation(); nextImage();">&gt;</div>
        
        <!-- 关闭按钮 -->
        <div style="position: absolute; top: 20px; right: 30px; color: white; font-size: 30px; cursor: pointer;" onclick="closeImagePreview()">&times;</div>
        
        <!-- 下载按钮 -->
        <div id="downloadBtn" style="position: absolute; top: 20px; right: 80px; color: white; font-size: 24px; cursor: pointer; padding: 5px;" onclick="event.stopPropagation(); downloadCurrentImage();" title="下载图片">⬇</div>
        
        <!-- 图片计数器 -->
        <div id="imageCounter" style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); color: white; font-size: 16px;"></div>
    </div>
    
    <script>
        var currentImageIndex = 0;
        var imageUrls = [
            <% for (var j = 0; j < photos.length; j++) { %>
                '<%- photos[j].img_url %>'<% if (j < photos.length - 1) { %>,<% } %>
            <% } %>
        ];
        
        function openImagePreview(index, imageUrl) {
            currentImageIndex = index;
            document.getElementById('previewImage').src = imageUrl;
            document.getElementById('imagePreviewModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            updateImageCounter();
            updateNavigationButtons();
        }
        
        function closeImagePreview() {
            document.getElementById('imagePreviewModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function prevImage() {
            if (currentImageIndex > 0) {
                currentImageIndex--;
                document.getElementById('previewImage').src = imageUrls[currentImageIndex];
                updateImageCounter();
                updateNavigationButtons();
            }
        }
        
        function nextImage() {
            if (currentImageIndex < imageUrls.length - 1) {
                currentImageIndex++;
                document.getElementById('previewImage').src = imageUrls[currentImageIndex];
                updateImageCounter();
                updateNavigationButtons();
            }
        }
        
        function updateImageCounter() {
            document.getElementById('imageCounter').textContent = (currentImageIndex + 1) + ' / ' + imageUrls.length;
        }
        
        function updateNavigationButtons() {
            document.getElementById('prevBtn').style.opacity = currentImageIndex > 0 ? '1' : '0.3';
            document.getElementById('nextBtn').style.opacity = currentImageIndex < imageUrls.length - 1 ? '1' : '0.3';
        }
        
        function downloadCurrentImage() {
            var currentImageUrl = imageUrls[currentImageIndex];
            var link = document.createElement('a');
            link.href = currentImageUrl;
            link.download = 'image_' + (currentImageIndex + 1) + '.jpg';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // 键盘导航
        document.addEventListener('keydown', function(event) {
            if (document.getElementById('imagePreviewModal').style.display === 'block') {
                if (event.key === 'Escape') {
                    closeImagePreview();
                } else if (event.key === 'ArrowLeft') {
                    prevImage();
                } else if (event.key === 'ArrowRight') {
                    nextImage();
                }
            }
        });
    </script>
</main>
